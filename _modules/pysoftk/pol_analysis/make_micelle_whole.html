<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pysoftk.pol_analysis.make_micelle_whole &mdash; PySoftK 1.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=292eb321"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            PySoftK
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">pysoftk</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PySoftK</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pysoftk.pol_analysis.make_micelle_whole</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pysoftk.pol_analysis.make_micelle_whole</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">pysoftk.pol_analysis.tools.utils_mda</span> <span class="kn">import</span> <span class="n">MDA_input</span>
<span class="kn">from</span> <span class="nn">pysoftk.pol_analysis.tools.utils_tools</span> <span class="kn">import</span> <span class="o">*</span>

<div class="viewcode-block" id="timeit">
<a class="viewcode-back" href="../../../pysoftk.pol_analysis.html#pysoftk.pol_analysis.make_micelle_whole.timeit">[docs]</a>
<span class="k">def</span> <span class="nf">timeit</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">timeit_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">time</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">total_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Elapsed time for matrix calculation: </span><span class="si">{:.4f}</span><span class="s1"> seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">total_time</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">timeit_wrapper</span></div>



<div class="viewcode-block" id="micelle_whole">
<a class="viewcode-back" href="../../../pysoftk.pol_analysis.html#pysoftk.pol_analysis.make_micelle_whole.micelle_whole">[docs]</a>
<span class="k">class</span> <span class="nc">micelle_whole</span><span class="p">(</span><span class="n">MDA_input</span><span class="p">):</span>
<span class="w">   </span><span class="sd">&quot;&quot;&quot;A class used to make the largest micelle whole across </span>
<span class="sd">      the pbc for better analysis.</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tpr_file</span><span class="p">,</span> <span class="n">xtc_file</span><span class="p">):</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;Instantiating the MDA_input class as</span>
<span class="sd">         super function.</span>
<span class="sd">      &quot;&quot;&quot;</span>
       
      <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">tpr_file</span><span class="p">,</span> <span class="n">xtc_file</span><span class="p">)</span>
  
<div class="viewcode-block" id="micelle_whole.obtain_largest_micelle_resids">
<a class="viewcode-back" href="../../../pysoftk.pol_analysis.html#pysoftk.pol_analysis.make_micelle_whole.micelle_whole.obtain_largest_micelle_resids">[docs]</a>
   <span class="k">def</span> <span class="nf">obtain_largest_micelle_resids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spatial_clustering_results</span><span class="p">):</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;Function to obtain the largest micelle resids Bare in mind this may give two </span>
<span class="sd">         different clusters if they have the same size - should check that you only select </span>
<span class="sd">         one when using the results from here</span>
<span class="sd">         </span>
<span class="sd">         Note-need to check if it actually gives two different clusters if they have </span>
<span class="sd">         the same size.</span>
<span class="sd">           </span>
<span class="sd">         Parameters</span>
<span class="sd">         ------------</span>
<span class="sd">         </span>
<span class="sd">         spatial_clustering_results : pandas.DataFrame</span>
<span class="sd">            Results from clustering analysis class. </span>
<span class="sd">            Pandas dataframe with three columns: time (ps),  </span>
<span class="sd">            micelle_resids and micelle_size</span>
<span class="sd">          </span>
<span class="sd">             </span>
<span class="sd">         Returns</span>
<span class="sd">         --------</span>
<span class="sd">         </span>
<span class="sd">         longest_lists : list</span>
<span class="sd">            list with the number resids (of MDanalysis) of the largets micelle at the timesteps</span>
<span class="sd">            that want to be evaluated.</span>
<span class="sd">             </span>
<span class="sd">      &quot;&quot;&quot;</span>

      <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
      <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

      
      <span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">spatial_clustering_results</span><span class="p">))</span>
      <span class="n">cluster_resids_tot</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;micelle_resids&#39;</span><span class="p">]</span>
      <span class="n">longest_lists</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cluster_resids_tot</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>

      <span class="k">return</span> <span class="n">longest_lists</span></div>




<div class="viewcode-block" id="micelle_whole.pbc_per_dimension">
<a class="viewcode-back" href="../../../pysoftk.pol_analysis.html#pysoftk.pol_analysis.make_micelle_whole.micelle_whole.pbc_per_dimension">[docs]</a>
   <span class="k">def</span> <span class="nf">pbc_per_dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cluster_sel_positions</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">dimension</span><span class="p">,</span> <span class="n">bins_min</span><span class="p">,</span> <span class="n">bins_max</span><span class="p">,</span> <span class="n">bins_step</span><span class="p">):</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;Function to find the broken parts of the micelle across the pbc and make it whole</span>

<span class="sd">         Parameters</span>
<span class="sd">         ------------</span>
<span class="sd">         </span>
<span class="sd">         spatial_clustering_results : np.array</span>
<span class="sd">            Numpy array with the positions of the resids </span>
<span class="sd">            of interest. It needs to have the shape of n_molec x 3</span>
<span class="sd">         </span>
<span class="sd">         box : np.array</span>
<span class="sd">            Numpy array with the MDanalysis strat u.dimensions. Array with the x y and z dimensions</span>
<span class="sd">            follow by the angles of the box.</span>

<span class="sd">         dimension : class.int</span>
<span class="sd">            Dimension number that wants to be evaluated</span>

<span class="sd">         bins_min : class.int</span>
<span class="sd">            Smallest distance to evaluate if the pbc are broken (smallest x-y distance position)</span>

<span class="sd">         bins_max : class.int</span>
<span class="sd">            Biggest distance to evaluate if the pbc are broken (largest x-y distance position)</span>

<span class="sd">         bins_step : class.int</span>
<span class="sd">            Step between bins to evaluate broken pbc</span>

<span class="sd">            </span>
<span class="sd">         Returns</span>
<span class="sd">         --------</span>
<span class="sd">         </span>
<span class="sd">         cluster_sel_positions_return : np.array</span>
<span class="sd">            Array with the atom positions of the micelle made whole across the pbc</span>
<span class="sd">      </span>
<span class="sd">      &quot;&quot;&quot;</span>

      <span class="kn">import</span> <span class="nn">MDAnalysis</span> <span class="k">as</span> <span class="nn">mda</span> 
      <span class="kn">import</span> <span class="nn">MDAnalysis.analysis.distances</span>
      <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
      <span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>

      <span class="n">cluster_sel_positions_return</span><span class="o">=</span><span class="n">cluster_sel_positions</span><span class="p">[:,</span><span class="n">dimension</span><span class="p">]</span>

      <span class="n">y</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">binned_statistic</span><span class="p">(</span><span class="n">cluster_sel_positions_return</span><span class="p">,</span>
                                     <span class="n">cluster_sel_positions_return</span><span class="p">,</span>
                                     <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">bins_min</span><span class="p">,</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">bins_max</span><span class="p">,</span> <span class="n">bins_step</span><span class="p">),</span>
                                     <span class="n">statistic</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">statistic</span>
        
       
      <span class="n">a</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">binned_statistic</span><span class="p">(</span><span class="n">cluster_sel_positions_return</span><span class="p">,</span>
                                   <span class="n">cluster_sel_positions_return</span><span class="p">,</span>
                                   <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">bins_min</span><span class="p">,</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">bins_max</span><span class="p">,</span> <span class="n">bins_step</span><span class="p">),</span>
                                   <span class="n">statistic</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">bin_edges</span>
        

        
      <span class="n">move_above</span><span class="o">=</span><span class="kc">False</span>
      <span class="n">filled</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span><span class="o">!=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

      <span class="n">move_above</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">filled</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filled</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">filled</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="n">filled</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span> <span class="p">]</span>

          
      <span class="k">if</span> <span class="n">move_above</span><span class="o">!=</span> <span class="kc">False</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">move_above</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
         <span class="n">array</span> <span class="o">=</span> <span class="n">cluster_sel_positions_return</span>

         <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">move_above</span><span class="p">:</span>
            <span class="n">cluster_sel_positions_return</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">array</span> <span class="o">&gt;</span> <span class="n">item</span><span class="p">)]</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">array</span> <span class="o">&gt;</span> <span class="n">item</span><span class="p">)]</span><span class="o">-</span><span class="n">box</span><span class="p">[</span><span class="n">dimension</span><span class="p">]</span> 

       
      <span class="k">return</span> <span class="n">cluster_sel_positions_return</span></div>



<div class="viewcode-block" id="micelle_whole.get_polymer_positions">
<a class="viewcode-back" href="../../../pysoftk.pol_analysis.html#pysoftk.pol_analysis.make_micelle_whole.micelle_whole.get_polymer_positions">[docs]</a>
   <span class="k">def</span> <span class="nf">get_polymer_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">cluster_resids</span><span class="p">):</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;Function to find the polymer positions</span>

<span class="sd">         Parameters</span>
<span class="sd">         ------------</span>
<span class="sd">         </span>
<span class="sd">         u : MDAnalysis.Universe</span>
<span class="sd">           An user-provided MDAnalysis universe.</span>
<span class="sd">         </span>
<span class="sd">         frame : class.int</span>
<span class="sd">            Time frame for calculation to be done.</span>

<span class="sd">         resname : class.list</span>
<span class="sd">            List of strings with the resname of the polymers.</span>

<span class="sd">         cluster_resids : class.str or class.int</span>
<span class="sd">            List with the polymer resids. </span>
<span class="sd">            </span>
<span class="sd">             </span>
<span class="sd">         Returns</span>
<span class="sd">         --------</span>
<span class="sd">         </span>
<span class="sd">         box : np.array</span>
<span class="sd">            Array with the u.dimensions</span>

<span class="sd">         cluster_atom_positions : np.array</span>
<span class="sd">            Array with the atom positions of the micelle/cluster.</span>

<span class="sd">         cluster_sel : np.array</span>
<span class="sd">            Array with the atoms that belong to the micelle/cluster.</span>
<span class="sd">         </span>
<span class="sd">      &quot;&quot;&quot;</span>

      <span class="kn">import</span> <span class="nn">MDAnalysis</span> <span class="k">as</span> <span class="nn">mda</span>
    
      <span class="n">u</span><span class="o">.</span><span class="n">trajectory</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span>
      <span class="c1">#print(&quot; &quot;.join([str(item) for item in resname]))</span>
      <span class="c1">#print(&quot; &quot;.join([str(i) for i in cluster_resids]))</span>
      <span class="n">cluster_sel</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="s1">&#39;resname &#39;</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">resname</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; and resid &#39;</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cluster_resids</span><span class="p">]))</span>
      <span class="c1">#print(cluster_sel) </span>
      <span class="n">cluster_atoms_positions</span><span class="o">=</span><span class="n">cluster_sel</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
      <span class="n">box</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">dimensions</span>  

      <span class="k">return</span> <span class="n">box</span><span class="p">,</span> <span class="n">cluster_atoms_positions</span><span class="p">,</span> <span class="n">cluster_sel</span></div>


<div class="viewcode-block" id="micelle_whole.count_dimensions">
<a class="viewcode-back" href="../../../pysoftk.pol_analysis.html#pysoftk.pol_analysis.make_micelle_whole.micelle_whole.count_dimensions">[docs]</a>
   <span class="k">def</span> <span class="nf">count_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">cluster_atoms_positions</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">):</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;Function to get the dimensions of a system, the box size and </span>
<span class="sd">         cluster_atom_positions in the form to use in make_cluster_whole</span>

<span class="sd">         Parameters</span>
<span class="sd">         ------------</span>
<span class="sd">         </span>
<span class="sd">         box : np.array</span>
<span class="sd">            u.dimensions</span>
<span class="sd">        </span>
<span class="sd">         cluster_atom_positions : np.array</span>
<span class="sd">            Array with the atom positions of the polymers belonging to the cluster</span>

<span class="sd">         dimensions :  class.int</span>
<span class="sd">            Number of dimensions</span>
<span class="sd">             </span>
<span class="sd">         Returns</span>
<span class="sd">         --------</span>

<span class="sd">         box : np.array</span>
<span class="sd">            Array with the u.dimensions to feed in into make_cluster_whole</span>

<span class="sd">         cluster_atom_positions : np.array</span>
<span class="sd">            Array with the atom positions of the micelle/cluster in the correct shape </span>
<span class="sd">            to feed it into make_cluster_whole</span>

<span class="sd">         dimensions : class.list</span>
<span class="sd">            List with the number of dimensions. E.g. 3D=[0, 1, 2]</span>
<span class="sd">         </span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">dimensions</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dimensions</span><span class="p">)]</span>
      <span class="n">cluster_atoms_positions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dimensions</span><span class="p">)</span><span class="o">*</span><span class="p">[</span><span class="n">cluster_atoms_positions</span><span class="p">]</span>
      <span class="n">box</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dimensions</span><span class="p">)</span><span class="o">*</span><span class="p">[</span><span class="n">box</span><span class="p">]</span>

      <span class="k">return</span> <span class="n">box</span><span class="p">,</span> <span class="n">cluster_atoms_positions</span><span class="p">,</span> <span class="n">dimensions</span></div>


<div class="viewcode-block" id="micelle_whole.make_cluster_whole">
<a class="viewcode-back" href="../../../pysoftk.pol_analysis.html#pysoftk.pol_analysis.make_micelle_whole.micelle_whole.make_cluster_whole">[docs]</a>
   <span class="k">def</span> <span class="nf">make_cluster_whole</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">frame</span><span class="p">,</span>
                       <span class="n">resname</span><span class="p">,</span>
                       <span class="n">cluster_resids</span><span class="p">,</span>
                       <span class="n">bins_min</span><span class="p">,</span>
                       <span class="n">bins_max</span><span class="p">,</span>
                       <span class="n">bins_step</span><span class="p">,</span>
                       <span class="n">dimensions</span><span class="o">=</span><span class="mi">3</span>
                       <span class="p">):</span>
<span class="w">      </span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;Function to make a polymer cluster whole across the pbc</span>

<span class="sd">         Parameters</span>
<span class="sd">         ------------</span>
<span class="sd">         </span>
<span class="sd">         frame : class.int</span>
<span class="sd">            Time frame that wants to be made whole</span>

<span class="sd">         resname : class.list</span>
<span class="sd">            List with the resname of the molecules of the cluster</span>

<span class="sd">         cluster_resids : class.list</span>
<span class="sd">            List with resids of the polymers that want to be made whole</span>

<span class="sd">         bins_min : class.int</span>
<span class="sd">            Smallest distance to evaluate if the pbc are broken (smallest x-y distance position)</span>

<span class="sd">         bins_max : class.int</span>
<span class="sd">            Biggest distance to evaluate if the pbc are broken (largest x-y distance position)</span>

<span class="sd">         bins_step : class.int</span>
<span class="sd">            Step between bins to evaluate broken pbc</span>
<span class="sd">            </span>
<span class="sd">         </span>
<span class="sd">         Returns</span>
<span class="sd">         --------</span>
<span class="sd">         </span>
<span class="sd">         frame : class.int</span>
<span class="sd">            Time frame where the micelle has been made whole</span>

<span class="sd">         atom_positions_whole : np.array</span>
<span class="sd">            Array with the atom positions of the micelle made whole across the pbc</span>
<span class="sd">      </span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="kn">import</span> <span class="nn">MDAnalysis</span> <span class="k">as</span> <span class="nn">mda</span>
      <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
      
      <span class="n">u</span><span class="o">=</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_mda_universe</span><span class="p">()</span>

      <span class="n">u</span><span class="o">.</span><span class="n">trajectory</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span> 
      <span class="n">box</span><span class="p">,</span> <span class="n">cluster_atoms_positions</span><span class="p">,</span> <span class="n">cluster_sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_polymer_positions</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">cluster_resids</span><span class="p">)</span>
      <span class="n">res_box</span><span class="p">,</span> <span class="n">res_clu_atoms</span><span class="p">,</span> <span class="n">res_dimensions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">count_dimensions</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">cluster_atoms_positions</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">)</span>
      
      <span class="n">bins_min</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res_dimensions</span><span class="p">)</span><span class="o">*</span><span class="p">[</span><span class="n">bins_min</span><span class="p">]</span>
      <span class="n">bins_max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res_dimensions</span><span class="p">)</span><span class="o">*</span><span class="p">[</span><span class="n">bins_max</span><span class="p">]</span>
      <span class="n">bins_step</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res_dimensions</span><span class="p">)</span><span class="o">*</span><span class="p">[</span><span class="n">bins_step</span><span class="p">]</span>
    
      <span class="n">atom_positions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pbc_per_dimension</span><span class="p">,</span> <span class="n">res_clu_atoms</span><span class="p">,</span> <span class="n">res_box</span><span class="p">,</span> <span class="n">res_dimensions</span><span class="p">,</span> <span class="n">bins_min</span><span class="p">,</span> <span class="n">bins_max</span><span class="p">,</span> <span class="n">bins_step</span><span class="p">))</span>
      <span class="n">atom_positions_whole</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">atom_positions</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> 
   
      <span class="k">return</span> <span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">atom_positions_whole</span><span class="p">)</span></div>



<div class="viewcode-block" id="micelle_whole.running_make_cluster_whole">
<a class="viewcode-back" href="../../../pysoftk.pol_analysis.html#pysoftk.pol_analysis.make_micelle_whole.micelle_whole.running_make_cluster_whole">[docs]</a>
   <span class="nd">@timeit</span>
   <span class="k">def</span> <span class="nf">running_make_cluster_whole</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">cluster_resids</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span> <span class="n">bins_min</span><span class="o">=-</span><span class="mi">50</span><span class="p">,</span> 
                                  <span class="n">bins_max</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">bins_step</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;Function to run the make_cluster_whole function over several frames </span>

<span class="sd">         Parameters</span>
<span class="sd">         ------------</span>
<span class="sd">         </span>
<span class="sd">         resname : class.list</span>
<span class="sd">            List with the resname of the molecules of the cluster in each time step.</span>

<span class="sd">         cluster_resids : class.list</span>
<span class="sd">            List with resids of the polymers that want to be made whole in each time step.</span>

<span class="sd">         start : class.int</span>
<span class="sd">            Starting frame to perfomr the calculation.</span>

<span class="sd">         stop : class.int</span>
<span class="sd">            Last frame to perform the calculation.</span>

<span class="sd">         skip : class.int</span>
<span class="sd">            Length of step to perform the calculation every number </span>
<span class="sd">            of frames.</span>

<span class="sd">         bins_min : class.int</span>
<span class="sd">            Smallest distance to evaluate if the pbc are broken (smallest x-y distance position).</span>

<span class="sd">         bins_max : class.int</span>
<span class="sd">            Biggest distance to evaluate if the pbc are broken (largest x-y distance position).</span>

<span class="sd">         bins_step : class.int</span>
<span class="sd">            Step between bins to evaluate broken pbc.</span>
<span class="sd">              </span>
<span class="sd">             </span>
<span class="sd">         Returns</span>
<span class="sd">         --------</span>
<span class="sd">         </span>
<span class="sd">         atom_positions_over_trajectory :  class.list </span>
<span class="sd">            List of np.arrays where each entry of the list is the position of atoms that are </span>
<span class="sd">            made whole across the pbc at a specific time step.</span>

<span class="sd">      &quot;&quot;&quot;</span>

      <span class="kn">import</span> <span class="nn">MDAnalysis</span> <span class="k">as</span> <span class="nn">mda</span>
      <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
      
      <span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>

      
      <span class="n">u</span><span class="o">=</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_mda_universe</span><span class="p">()</span>
      <span class="n">frames</span> <span class="o">=</span><span class="p">[</span><span class="n">ts</span><span class="o">.</span><span class="n">frame</span> <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">trajectory</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">stop</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">skip</span><span class="p">)]]</span>

      <span class="n">resname</span> <span class="o">=</span> <span class="p">[</span><span class="n">resname</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>
      <span class="n">cluster_resids_f</span> <span class="o">=</span> <span class="p">[</span><span class="n">cluster_resids</span><span class="p">]</span>
                                      
      <span class="n">bins_min</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span><span class="o">*</span><span class="p">[</span><span class="n">bins_min</span><span class="p">]</span>
      <span class="n">bins_max</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span><span class="o">*</span><span class="p">[</span><span class="n">bins_max</span><span class="p">]</span>
      <span class="n">bins_step</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span><span class="o">*</span><span class="p">[</span><span class="n">bins_step</span><span class="p">]</span>

      <span class="c1"># Single-threaded version of</span>
      <span class="c1">#atom_positions_over_trajectory = executor.map(self.make_cluster_whole, frames, resname, cluster_resids_f[0], bins_min, bins_max, bins_step)</span>
                                      
      
      <span class="n">atom_positions_over_trajectory</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">make_cluster_whole</span><span class="p">,</span> <span class="n">frames</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">cluster_resids_f</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                                                                <span class="n">bins_min</span><span class="p">,</span> <span class="n">bins_max</span><span class="p">,</span> <span class="n">bins_step</span><span class="p">),</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">))</span>

      <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">atom_positions_over_trajectory</span><span class="p">)</span></div>



<div class="viewcode-block" id="micelle_whole.get_atom_name_list">
<a class="viewcode-back" href="../../../pysoftk.pol_analysis.html#pysoftk.pol_analysis.make_micelle_whole.micelle_whole.get_atom_name_list">[docs]</a>
   <span class="k">def</span> <span class="nf">get_atom_name_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_sel</span><span class="p">):</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;Function to obtain the residues based on user-provided atom selection.</span>


<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>

<span class="sd">        atom_sel: class.str</span>
<span class="sd">          User Provided name/tag of the molecules inside the box.</span>



<span class="sd">        Returns</span>
<span class="sd">        ---------</span>

<span class="sd">        final: class.list</span>
<span class="sd">          List containing all names of atoms.</span>

<span class="sd">      &quot;&quot;&quot;</span>
      <span class="kn">import</span> <span class="nn">itertools</span>
        
      <span class="n">b</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">atom_sel</span><span class="p">]</span>
      <span class="n">c</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="p">[])</span>

      <span class="c1">#creating permutation list</span>
      <span class="n">final</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">2</span><span class="p">))))</span> 

      <span class="k">return</span> <span class="n">final</span></div>



<div class="viewcode-block" id="micelle_whole.obtain_snapshot">
<a class="viewcode-back" href="../../../pysoftk.pol_analysis.html#pysoftk.pol_analysis.make_micelle_whole.micelle_whole.obtain_snapshot">[docs]</a>
   <span class="k">def</span> <span class="nf">obtain_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_name</span><span class="p">,</span> <span class="n">atom_positions_at_specific_frame</span><span class="p">,</span> <span class="n">cluster_resids</span><span class="p">,</span> <span class="n">polymer_resname</span><span class="p">,</span> 
                       <span class="n">frame</span><span class="p">,</span> <span class="n">water_resname</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SOL&#39;</span><span class="p">],</span> <span class="n">water_atom_name</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;OW&#39;</span><span class="p">],</span> <span class="n">solvant</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;Function to obtain an snapshot of the micelle (pdb) file of a specific </span>
<span class="sd">         frame and returns the new universe to analyse.</span>
<span class="sd">         </span>
<span class="sd">         Parameters</span>
<span class="sd">         -----------</span>

<span class="sd">         output_name : class.str</span>
<span class="sd">            Name of output file</span>

<span class="sd">         atom_positions_at_specific_frame : np.array</span>
<span class="sd">            Position of atoms at a specific frame</span>

<span class="sd">         cluster_resids : class.list</span>
<span class="sd">            List of polymers resids for the snapshot</span>

<span class="sd">         frame : class.int</span>
<span class="sd">            Time frame for snapshot</span>

<span class="sd">         water_resname : class.list</span>
<span class="sd">            List with name of solvants</span>

<span class="sd">         water_atom_name : class.list</span>
<span class="sd">            List of solvant atom names that want to be outputed in the sanpshot. E.g. with water </span>
<span class="sd">            you may only be interested in outputing the oxygen water atom for further calculations</span>

<span class="sd">         solvant : class.boolean</span>
<span class="sd">            Set to True if interested in obtainig an output snapshot with the solvant too. </span>

<span class="sd">         </span>
<span class="sd">         Returns</span>
<span class="sd">         --------</span>

<span class="sd">         u3: MDAnalysis.Universe</span>
<span class="sd">            An MDAnalysis universe containing the resulting frames</span>

<span class="sd">         output: MDAnalysis.Write</span>
<span class="sd">            A PDB file containing the selected molecules.</span>
<span class="sd">            </span>
<span class="sd">      &quot;&quot;&quot;</span>

      <span class="kn">import</span> <span class="nn">MDAnalysis</span> <span class="k">as</span> <span class="nn">mda</span>
      <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
      <span class="kn">import</span> <span class="nn">concurrent.futures</span>
      <span class="kn">from</span> <span class="nn">MDAnalysis</span> <span class="kn">import</span> <span class="n">transformations</span> <span class="k">as</span> <span class="n">trans</span>
  
      
      <span class="n">u2</span><span class="o">=</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_mda_universe</span><span class="p">()</span>

      <span class="n">u2</span><span class="o">.</span><span class="n">trajectory</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">frame</span><span class="p">)]</span>
    
      <span class="n">positions_atoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">atom_positions_at_specific_frame</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
      <span class="n">micelle</span> <span class="o">=</span> <span class="n">u2</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="s1">&#39;resname &#39;</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">polymer_resname</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; and resid &#39;</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cluster_resids</span><span class="p">]))</span>

      <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">micelle</span><span class="p">))</span>
      <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">positions_atoms</span><span class="p">))</span>
     
      <span class="n">micelle</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="n">positions_atoms</span>


      <span class="c1">#if any of the box is </span>

      <span class="k">if</span> <span class="n">solvant</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>         
         <span class="n">system</span> <span class="o">=</span> <span class="n">u2</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="s1">&#39;resid &#39;</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cluster_resids</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; or (resname &#39;</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">water_resname</span><span class="p">])</span> <span class="o">+</span><span class="s1">&#39; and name &#39;</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">water_atom_name</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
   
         <span class="n">workflow</span> <span class="o">=</span> <span class="p">(</span><span class="n">trans</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">system</span><span class="p">),</span>
                     <span class="n">trans</span><span class="o">.</span><span class="n">center_in_box</span><span class="p">(</span><span class="n">micelle</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="s1">&#39;mass&#39;</span><span class="p">),</span>
                     <span class="n">trans</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">compound</span><span class="o">=</span><span class="s1">&#39;fragments&#39;</span><span class="p">))</span>

         <span class="n">u2</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">add_transformations</span><span class="p">(</span><span class="o">*</span><span class="n">workflow</span><span class="p">)</span>
    
         <span class="k">with</span> <span class="n">mda</span><span class="o">.</span><span class="n">Writer</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_name</span><span class="p">),</span> <span class="n">system</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">)</span> <span class="k">as</span> <span class="n">W</span><span class="p">:</span> 
            <span class="n">W</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>

         <span class="n">u3</span> <span class="o">=</span> <span class="n">mda</span><span class="o">.</span><span class="n">Universe</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_name</span><span class="p">))</span>
         <span class="k">return</span> <span class="n">u3</span>
      

      <span class="k">else</span><span class="p">:</span>
          <span class="k">with</span> <span class="n">mda</span><span class="o">.</span><span class="n">Writer</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_name</span><span class="p">),</span> <span class="n">micelle</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">)</span> <span class="k">as</span> <span class="n">W</span><span class="p">:</span>
               <span class="n">W</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">micelle</span><span class="p">)</span>

          <span class="n">u3</span> <span class="o">=</span> <span class="n">mda</span><span class="o">.</span><span class="n">Universe</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_name</span><span class="p">))</span>
          <span class="k">return</span> <span class="n">u3</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Alejandro Santana-Bonilla, Raquel Lopez-Rios de Castro, and Chris Lorenz.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>